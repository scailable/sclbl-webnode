<html>
<head>
    <h1>Bare bones WASI browser polyfill demo</h1>
</head>

<body>
    <script>

        var barebonesWASI = function() {
		
                var moduleInstanceExports = null;

                var WASI_ESUCCESS = 0;
                var WASI_EBADF = 8;
                var WASI_EINVAL = 28;
                var WASI_ENOSYS = 52;

                var WASI_STDOUT_FILENO = 1;

                function setModuleInstance(instance) {
                    
                    moduleInstanceExports = instance.exports;
                }

                function getModuleMemoryDataView() {
                    // call this any time you'll be reading or writing to a module's memory 
                    // the returned DataView tends to be dissaociated with the module's memory buffer at the will of the WebAssembly engine 
                    // cache the returned DataView at your own peril!!
                    
                    return new DataView(moduleInstanceExports.memory.buffer);
                }

                function fd_prestat_get(fd, bufPtr) {
                    
                    return WASI_EBADF;
                }

                function fd_prestat_dir_name(fd, pathPtr, pathLen) {
                     
                     return WASI_EINVAL;
                }

                function environ_sizes_get(environCount, environBufSize) {
                    
                    var view = getModuleMemoryDataView();

                    view.setUint32(environCount, 0, !0);
                    view.setUint32(environBufSize, 0, !0);
                    
                    return WASI_ESUCCESS;
                }

                function environ_get(environ, environBuf) {
                    
                    return WASI_ESUCCESS;
                }

                function args_sizes_get(argc, argvBufSize) {
                    
                    var view = getModuleMemoryDataView();

                    view.setUint32(argc, 0, !0);
                    view.setUint32(argvBufSize, 0, !0);

                    return WASI_ESUCCESS;
                }

                 function args_get(argv, argvBuf) {
                    
                    return WASI_ESUCCESS;
                }
                
                function fd_fdstat_get(fd, bufPtr) {

                    var view = getModuleMemoryDataView();

                    view.setUint8(bufPtr, fd);
                    view.setUint16(bufPtr + 2, 0, !0);
                    view.setUint16(bufPtr + 4, 0, !0);
                    
                    function setBigUint64(byteOffset, value, littleEndian) {

                        var lowWord = value;
                        var highWord = 0;

                        view.setUint32(littleEndian ? 0 : 4, lowWord, littleEndian);
                        view.setUint32(littleEndian ? 4 : 0, highWord, littleEndian);
                   }
                    
                    setBigUint64(bufPtr + 8, 0, !0);
                    setBigUint64(bufPtr + 8 + 8, 0, !0);
                    
                    return WASI_ESUCCESS;
                }


                function fd_write(fd, iovs, iovsLen, nwritten) {

                    console.log("writing...")
                    
                    var view = getModuleMemoryDataView();
                    
                    var written = 0;
                    var bufferBytes = [];                   

                    function getiovs(iovs, iovsLen) {
                        // iovs* -> [iov, iov, ...]
                        // __wasi_ciovec_t {
                        //   void* buf,
                        //   size_t buf_len,
                        // }
                        var buffers = Array.from({ length: iovsLen }, function (_, i) {
                               var ptr = iovs + i * 8;
                               var buf = view.getUint32(ptr, !0);
                               var bufLen = view.getUint32(ptr + 4, !0);
                                
                               return new Uint8Array(moduleInstanceExports.memory.buffer, buf, bufLen);
                            });
                        
                        return buffers;
                    }

                    var buffers = getiovs(iovs, iovsLen);
                    function writev(iov) {
                     
                        for (var b = 0; b < iov.byteLength; b++) {
                           
                           bufferBytes.push(iov[b]);
                        }
                        
                        written += b;
                    }
                    
                    buffers.forEach(writev);
                    

                    // I assume this can safely be ignored...
                    /*
                    if (fd === WASI_STDOUT_FILENO) {
                        console.log(String.fromCharCode.apply(null, bufferBytes));
                        console.log(bufferBytes)
                    }
                    */                            

                    view.setUint32(nwritten, written, !0);

                    console.log("writing done, not sure if correct...")
                    
                    return WASI_ESUCCESS;
                }


                // https://wasi.dev/polyfill/polyfill.js
                //function fd_write(fd, iovs, iovs_len, nwritten) {
                    //let host_iovs = translate_ciovs(iovs, iovs_len);
                    //let host_nwritten = _malloc(4);
                    //let ret = ___wasi_fd_write(fd, host_iovs, iovs_len, host_nwritten);
                    //copyout_i32(nwritten, host_nwritten);
                    //free_ciovs(host_iovs, iovs_len);
                    //return ret;
                    //return WASI_ESUCCESS;
                //}

                function poll_oneoff(sin, sout, nsubscriptions, nevents) {
                    
                    return WASI_ENOSYS;
                }

                function proc_exit(rval) {

                    /*
                    let message;
                    if (rval === 0) {
                        message = "success";
                    } else {
                        message = "error code " + rval;
                    }
                    throw new WASIExit(rval, message);
                    */
                    return WASI_ENOSYS;

                }

                /*
                function WASIExit(return_value, message, fileName, lineNumber) {
                    let instance = new Error(message, fileName, lineNumber);
                    instance.return_value = return_value;
                    Object.setPrototypeOf(instance, Object.getPrototypeOf(this));
                    if (Error.captureStackTrace) {
                        Error.captureStackTrace(instance, WASIExit);
                    }
                    return instance;
                }
                */

                function fd_close(fd) {

                    return WASI_ENOSYS;
                }
                
                function fd_seek(fd, offset, whence, newOffsetPtr) {

                }

                function fd_close(fd) {

                    return WASI_ENOSYS;
                }
                
                return {
                    setModuleInstance : setModuleInstance,
                    environ_sizes_get : environ_sizes_get,
                    args_sizes_get : args_sizes_get,
                    fd_prestat_get : fd_prestat_get,
                    fd_fdstat_get : fd_fdstat_get,
                    fd_write : fd_write,
                    fd_prestat_dir_name : fd_prestat_dir_name,
                    environ_get : environ_get,
                    args_get : args_get,
                    poll_oneoff : poll_oneoff,
                    proc_exit : proc_exit,
                    fd_close : fd_close,
                    fd_seek : fd_seek
                }               
            }

            function importWasmModule(moduleName, wasiPolyfill) {

                var memory = new WebAssembly.Memory({ initial: 2, maximum: 10 });
                const moduleImports = { wasi_unstable: wasiPolyfill, env : {}, js: { mem: memory } };

                (async () => {
                    var module = null;

                    if (WebAssembly.compileStreaming) {
                      module = await WebAssembly.compileStreaming(fetch(moduleName));
                    }
                    else {
                      const response = await fetch(moduleName);
                      const buffer = await response.arrayBuffer();
                      module = await WebAssembly.compile(buffer);
                    }

                    const instance = await WebAssembly.instantiate(module, moduleImports);
                                      
                    wasiPolyfill.setModuleInstance(instance);

                    instance.exports._start();
                    console.log(instance.exports)


                    // CUSTOM:
                    let inputStr = "[[2,5]]"
					
					let wasmMemory = new Uint8Array(instance.exports.memory.buffer);

		            // Set input
		            let inputUint8ArrayIn = new TextEncoder("utf-8").encode(inputStr);
		            //let inputLength = inputUint8ArrayIn.length;  //byteLength;
		            let p_input = instance.exports.malloc_buffer();
		            console.log(p_input)

		            // Run function
		            wasmMemory.set(inputUint8ArrayIn, p_input);
		            instance.exports.pred();
		            

		            // Get output
		            let p_output = instance.exports.get_out_loc();
		            fn = instance.exports.free_buffer();

		            // Get output
		            let outputLen = instance.exports.get_out_len();
					wasmMemory = new Uint8Array(instance.exports.memory.buffer);
		            let uint8array = wasmMemory.slice(p_output, p_output + outputLen);
		            let result = new TextDecoder().decode(uint8array);

					console.log(result);

		            instance.exports.free_buffer();


                })();
            }

			
            var wasiPolyfill = new barebonesWASI();
            //importWasmModule("https://cdn.sclbl.net:8000/file/e871d8e5-b2e2-11ea-a47d-9600004e79cc.wasm", wasiPolyfill); // Does not work
            importWasmModule("https://cdn.sclbl.net:8000/file/27d21872-c4ff-11ea-816c-9600004e79cc.wasm", wasiPolyfill); // Works
    </script>

    Open the browser console to see the output from the WebAssembly module.
</body>

</html>
